<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>STMBudget - Sales Budgeting & Rolling Forecast</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Advanced sales budgeting and rolling forecast management system">
    <meta name="keywords" content="sales, budget, forecast, management, analytics">
    <meta name="author" content="STMBudget">
    
    <!-- Progressive Web App -->
    <meta name="theme-color" content="#3b82f6">
    <link rel="manifest" href="{% static 'manifest.json' %}">
    
    <!-- Preload Critical Resources -->
    {% load static %}
    <link rel="preload" href="{% static 'css/base.css' %}" as="style">
    <link rel="preload" href="{% static 'css/components.css' %}" as="style">
    <link rel="preload" href="{% static 'js/base.js' %}" as="script">
    <link rel="preload" href="{% static 'js/spa-router.js' %}" as="script">
    
    <!-- CSS Bundle -->
    <link href="{% static 'vendor/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'css/base.css' %}" rel="stylesheet">
    <link href="{% static 'css/components.css' %}" rel="stylesheet">
    <link href="{% static 'css/dashboard.css' %}" rel="stylesheet">
    <link href="{% static 'css/forms.css' %}" rel="stylesheet">
    <link href="{% static 'css/tables.css' %}" rel="stylesheet">
    <link href="{% static 'css/charts.css' %}" rel="stylesheet">
    <link href="{% static 'css/animations.css' %}" rel="stylesheet">
    <link href="{% static 'css/responsive.css' %}" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{% static 'images/favicon.ico' %}">
    <link rel="apple-touch-icon" href="{% static 'images/apple-touch-icon.png' %}">
    
    <!-- Critical inline styles for instant loading -->
    <style>
        /* Instant loading optimization */
        .app-container {
            min-height: 100vh;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .app-container.loaded {
            opacity: 1;
        }
        
        /* Loading states */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        
        .loading-overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        .loading-content {
            text-align: center;
            color: white;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .loading-subtext {
            font-size: 14px;
            opacity: 0.8;
        }
        
        /* Page transition styles */
        .page-transition {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .page-transition.transitioning {
            opacity: 0;
            transform: translateY(10px);
        }
        
        /* Performance optimizations */
        .navbar, .sidebar {
            will-change: transform;
        }
        
        .card, .modal {
            will-change: transform, opacity;
        }
    </style>
</head>
<body class="spa-app">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">STMBudget</div>
            <div class="loading-subtext">Loading your dashboard...</div>
        </div>
    </div>

    <!-- SPA Container -->
    <div id="app-container" class="app-container">
        <!-- Navigation Header (Persistent) -->
        <div id="navbar-container">
            {% include 'base/components/navbar.html' %}
        </div>
        
        <!-- Sidebar Container (Persistent for non-salesman) -->
        <div id="sidebar-container">
            {% if user.is_authenticated and user.role != 'salesman' %}
                {% include 'base/components/sidebar.html' %}
            {% endif %}
        </div>
        
        <!-- Horizontal Navigation for Salesman (Persistent) -->
        {% if user.is_authenticated and user.role == 'salesman' %}
        <div id="horizontal-nav-container">
            {% include 'base/components/horizontal_nav.html' %}
        </div>
        {% endif %}
        
        <!-- Main Content Area (Dynamic) -->
        <main id="main-content" class="main-content-area page-transition {% if user.is_authenticated and user.role != 'salesman' %}with-sidebar{% endif %}" role="main">
            <!-- Dynamic content will be loaded here -->
            <div class="page-container">
                <div class="content-container">
                    <div class="initial-loading">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <h5>Preparing your workspace...</h5>
                            <p class="text-muted">Please wait while we load your dashboard</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Footer (Persistent) -->
        <footer id="footer-container">
            {% include 'base/components/footer.html' %}
        </footer>
    </div>

    <!-- Global Modals Container -->
    <div id="modals-container">
        {% include 'base/components/modals/password_modal.html' %}
        {% include 'base/components/modals/export_modal.html' %}
        {% include 'base/components/modals/confirmation_modal.html' %}
    </div>

    <!-- Toast Notifications Container -->
    <div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 11000;">
        <!-- Toast notifications will be inserted here -->
    </div>

    <!-- Backdrop for Mobile -->
    <div id="mobile-backdrop" class="mobile-backdrop"></div>

    <!-- JavaScript Bundle -->
    <script src="{% static 'vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'vendor/chartjs/chart.min.js' %}"></script>
    <script src="{% static 'vendor/datatables/jquery.dataTables.min.js' %}"></script>
    
    <!-- Core Application Scripts -->
    <script src="{% static 'js/utils/api.js' %}"></script>
    <script src="{% static 'js/utils/validation.js' %}"></script>
    <script src="{% static 'js/utils/date-utils.js' %}"></script>
    <script src="{% static 'js/utils/format-utils.js' %}"></script>
    
    <script src="{% static 'js/components/notifications.js' %}"></script>
    <script src="{% static 'js/components/modals.js' %}"></script>
    <script src="{% static 'js/components/forms.js' %}"></script>
    <script src="{% static 'js/components/tables.js' %}"></script>
    <script src="{% static 'js/components/search.js' %}"></script>
    
    <script src="{% static 'js/charts/chart-config.js' %}"></script>
    <script src="{% static 'js/charts/budget-charts.js' %}"></script>
    <script src="{% static 'js/charts/sales-charts.js' %}"></script>
    <script src="{% static 'js/charts/inventory-charts.js' %}"></script>
    
    <script src="{% static 'js/dashboard/dashboard.js' %}"></script>
    <script src="{% static 'js/dashboard/stats-cards.js' %}"></script>
    <script src="{% static 'js/dashboard/quick-actions.js' %}"></script>
    
    <script src="{% static 'js/base.js' %}"></script>
    <script src="{% static 'js/spa-router.js' %}"></script>

    <!-- Application Initialization -->
    <script>
        // User data for JavaScript access
        window.currentUser = {
            id: '{{ user.id|default:"" }}',
            name: '{{ user.get_full_name|default:user.username|default:"" }}',
            email: '{{ user.email|default:"" }}',
            role: '{{ user.role|default:"guest" }}',
            isAuthenticated: {% if user.is_authenticated %}true{% else %}false{% endif %}
        };

        // CSRF Token
        window.csrfToken = '{{ csrf_token }}';

        // Application configuration
        window.appConfig = {
            baseUrl: '{{ request.build_absolute_uri:"/" }}',
            staticUrl: '{% get_static_prefix %}',
            mediaUrl: '{% get_media_prefix %}',
            apiUrl: '/api/',
            websocketUrl: '{{ websocket_url|default:"" }}',
            debug: {% if debug %}true{% else %}false{% endif %}
        };

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸš€ STMBudget SPA initializing...');
            
            // Performance tracking
            STMBudget.performance.start('app-init');
            
            // Initialize core application
            STMBudget.init();
            
            // Setup SPA routes
            setupSPARoutes();
            
            // Initialize authentication middleware
            setupAuthMiddleware();
            
            // Setup error handling
            setupErrorHandling();
            
            // Setup performance monitoring
            setupPerformanceMonitoring();
            
            // Hide loading overlay and show app
            setTimeout(() => {
                const loadingOverlay = document.getElementById('loading-overlay');
                const appContainer = document.getElementById('app-container');
                
                loadingOverlay.classList.add('hidden');
                appContainer.classList.add('loaded');
                
                // Navigate to initial route
                const initialPath = window.location.pathname;
                router.navigate(initialPath, false);
                
                STMBudget.performance.end('app-init');
                console.log('âœ… STMBudget SPA initialized successfully');
            }, 1000);
        });

        /**
         * Setup SPA Routes
         */
        function setupSPARoutes() {
            console.log('ðŸ“ Setting up SPA routes...');
            
            // Authentication routes
            router.route('/', RouteHandlers.ajax('/api/dashboard/'), {
                title: 'Dashboard - STMBudget',
                roles: ['admin', 'salesman', 'manager', 'supply_chain']
            });
            
            router.route('/login', RouteHandlers.template('/templates/auth/login-content.html'), {
                title: 'Login - STMBudget'
            });
            
            // Dashboard routes
            router.route('/dashboard', RouteHandlers.ajax('/api/dashboard/'), {
                title: 'Dashboard - STMBudget',
                roles: ['admin', 'salesman', 'manager', 'supply_chain'],
                preload: true,
                cache: true
            });
            
            // Admin routes
            router.route('/admin/users', RouteHandlers.ajax('/api/admin/users/'), {
                title: 'User Management - STMBudget',
                roles: ['admin']
            });
            
            router.route('/admin/data-sources', RouteHandlers.ajax('/api/admin/data-sources/'), {
                title: 'Data Sources - STMBudget',
                roles: ['admin']
            });
            
            router.route('/admin/advanced', RouteHandlers.ajax('/api/admin/advanced/'), {
                title: 'Advanced Admin - STMBudget',
                roles: ['admin']
            });
            
            // Sales routes
            router.route('/sales/budget', RouteHandlers.ajax('/api/sales/budget/'), {
                title: 'Sales Budget - STMBudget',
                roles: ['admin', 'salesman', 'manager']
            });
            
            router.route('/sales/forecast', RouteHandlers.ajax('/api/sales/forecast/'), {
                title: 'Rolling Forecast - STMBudget',
                roles: ['admin', 'salesman', 'manager']
            });
            
            // Inventory routes
            router.route('/inventory', RouteHandlers.ajax('/api/inventory/'), {
                title: 'Inventory Management - STMBudget',
                roles: ['admin', 'supply_chain']
            });
            
            router.route('/inventory/distribution', RouteHandlers.ajax('/api/inventory/distribution/'), {
                title: 'Distribution Management - STMBudget',
                roles: ['admin', 'supply_chain']
            });
            
            // Manager routes
            router.route('/approval-center', RouteHandlers.ajax('/api/approval-center/'), {
                title: 'Approval Center - STMBudget',
                roles: ['admin', 'manager']
            });
            
            // Communication routes
            router.route('/communication', RouteHandlers.ajax('/api/communication/'), {
                title: 'Communication Center - STMBudget',
                roles: ['salesman', 'manager', 'supply_chain']
            });
            
            // Reports routes
            router.route('/reports/export', RouteHandlers.ajax('/api/reports/export/'), {
                title: 'Export Reports - STMBudget',
                roles: ['admin', 'salesman', 'manager', 'supply_chain']
            });
            
            router.route('/reports/bi', RouteHandlers.ajax('/api/reports/bi/'), {
                title: 'BI Dashboard - STMBudget',
                roles: ['admin']
            });
            
            // Error routes
            router.route('/404', RouteHandlers.template('/templates/errors/404.html'), {
                title: 'Page Not Found - STMBudget'
            });
            
            router.route('/403', RouteHandlers.template('/templates/errors/403.html'), {
                title: 'Access Denied - STMBudget'
            });
            
            router.route('/500', RouteHandlers.template('/templates/errors/500.html'), {
                title: 'Server Error - STMBudget'
            });
        }

        /**
         * Setup Authentication Middleware
         */
        function setupAuthMiddleware() {
            router.use(async (route, data, params) => {
                // Check if user is authenticated for protected routes
                if (route.roles && route.roles.length > 0) {
                    if (!window.currentUser.isAuthenticated) {
                        router.navigate('/login');
                        return false;
                    }
                    
                    // Check role permissions
                    if (!route.roles.includes(window.currentUser.role)) {
                        router.navigate('/403');
                        return false;
                    }
                }
                
                return true;
            });
        }

        /**
         * Setup Error Handling
         */
        function setupErrorHandling() {
            // Handle router events
            window.addEventListener('spa:notFound', (e) => {
                console.warn('Route not found:', e.detail.path);
                router.navigate('/404');
            });
            
            window.addEventListener('spa:unauthorized', (e) => {
                console.warn('Unauthorized access attempt');
                STMBudget.notifications.show('Access denied', 'error');
                router.navigate('/403');
            });
            
            window.addEventListener('spa:error', (e) => {
                console.error('SPA error:', e.detail.error);
                STMBudget.notifications.show('An error occurred', 'error');
            });
        }

        /**
         * Setup Performance Monitoring
         */
        function setupPerformanceMonitoring() {
            // Monitor route changes
            window.addEventListener('spa:routeChanged', (e) => {
                const { route, path } = e.detail;
                console.log(`ðŸ“„ Route changed: ${path} (${route.title})`);
                
                // Track page views
                if (window.gtag) {
                    gtag('config', 'GA_MEASUREMENT_ID', {
                        page_title: route.title,
                        page_location: window.location.href
                    });
                }
            });
            
            // Monitor performance
            if (window.performance && window.performance.observe) {
                const observer = new PerformanceObserver((list) => {
                    const entries = list.getEntries();
                    entries.forEach(entry => {
                        if (window.appConfig.debug) {
                            console.log(`âš¡ ${entry.name}: ${entry.duration.toFixed(2)}ms`);
                        }
                    });
                });
                
                observer.observe({ entryTypes: ['navigation', 'measure'] });
            }
        }

        // Global utilities for templates
        window.STMUtils = {
            formatCurrency: STMBudget.utils.formatCurrency,
            formatNumber: STMBudget.utils.formatNumber,
            formatDate: STMBudget.utils.formatDate,
            formatRelativeTime: STMBudget.utils.formatRelativeTime
        };
    </script>
</body>
</html>
