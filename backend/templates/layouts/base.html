<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="STMBudget - Advanced Budget Management System">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <title>{% block title %}STMBudget{% endblock %}</title>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="/static/css/app.css" as="style">
    <link rel="preload" href="/static/js/app.js" as="script">
    
    <!-- Critical CSS -->
    <style>
        /* Critical mobile-first CSS for immediate rendering */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f9fafb; display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .spinner { width: 40px; height: 40px; border: 3px solid #e5e7eb; border-top: 3px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .app-container { min-height: 100vh; display: flex; flex-direction: column; }
        .main-content { flex: 1; }
        
        /* Mobile-first responsive breakpoints */
        @media (max-width: 640px) { .hidden-mobile { display: none !important; } }
        @media (min-width: 641px) { .visible-mobile { display: none !important; } }
        
        /* Touch-friendly interactions */
        .touch-target { min-height: 44px; min-width: 44px; }
        .btn { padding: 12px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 500; transition: all 0.2s; }
        .btn:active { transform: scale(0.98); }
        
        /* App-like animations */
        .fade-in { animation: fadeIn 0.3s ease-out; }
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* PWA-like header */
        .app-header { background: #fff; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; z-index: 100; }
        
        /* Safe area support for mobile devices */
        .safe-area-top { padding-top: env(safe-area-inset-top); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
    
    <!-- Load main CSS asynchronously -->
    <link rel="stylesheet" href="/static/css/app.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="/static/css/app.css"></noscript>
    
    <!-- Manifest for PWA capabilities -->
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- iOS specific -->
    <meta name="apple-mobile-web-app-title" content="STMBudget">
    <link rel="apple-touch-icon" href="/static/images/icon-192x192.png">
    
    {% block extra_head %}{% endblock %}
</head>
<body class="h-full bg-gray-50 safe-area-top safe-area-bottom">
    <!-- Loading screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="spinner"></div>
    </div>
    
    <!-- App container -->
    <div id="app" class="app-container fade-in" style="display: none;">
        {% block navbar %}
            {% if user.is_authenticated %}
                {% include 'components/navbar.html' %}
            {% endif %}
        {% endblock %}
        
        <main class="main-content">
            {% block content %}{% endblock %}
        </main>
        
        {% block footer %}
            {% if user.is_authenticated %}
                {% include 'components/footer.html' %}
            {% endif %}
        {% endblock %}
    </div>
    
    <!-- Toast notifications container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
    
    <!-- Modal container -->
    <div id="modal-container"></div>
    
    <!-- Core JavaScript -->
    <script>
        // Remove loading screen once DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            const loadingScreen = document.getElementById('loading-screen');
            const app = document.getElementById('app');
            
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                app.style.display = 'flex';
            }, 100);
        });
        
        // CSRF token for Django
        window.CSRF_TOKEN = '{{ csrf_token }}';
        
        // User data for JavaScript
        window.USER_DATA = {% if user.is_authenticated %}{
            id: {{ user.id }},
            name: "{{ user.get_full_name|default:user.username }}",
            email: "{{ user.email }}",
            role: "{{ user.role|default:'user' }}",
            department: "{{ user.department|default:'' }}"
        }{% else %}null{% endif %};
        
        // App configuration
        window.APP_CONFIG = {
            apiUrl: '/api/',
            debug: {% if debug %}true{% else %}false{% endif %},
            version: '2.0.0'
        };
    </script>
    
    <!-- Load main JavaScript -->
    <script src="/static/js/app.js" defer></script>
    
    {% block extra_scripts %}{% endblock %}
    
    <!-- Service Worker for PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(function(registration) {
                        console.log('SW registered: ', registration);
                    })
                    .catch(function(registrationError) {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>
